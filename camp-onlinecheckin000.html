<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>醫學教育共識營 即時報到儀表板</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* THEME v10: Final Refinement + Debugged Layout + Mobile Optimized */
    body {
      /* 請確認圖片網址正確 */
      background-image: url('images/許文龍.jpg'); 
      background-size: cover; background-position: center; background-attachment: fixed; 
      font-family: 'Noto Sans TC', sans-serif; color: #374151;
    }
    /* 主容器：毛玻璃效果，90%不透明度以遮蔽背景干擾 */
    .overlay-content {
      background-color: rgba(248, 247, 245, 0.90); 
      border: 1px solid rgba(255, 255, 255, 0.3); 
      border-radius: 1.5rem; 
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); 
      margin: 1rem auto; 
      max-width: 90rem; 
      width: calc(100% - 2rem); 
      padding: 1.5rem;
    }

    /* 標題 */
    h1 { line-height: 1.4; }

    /* 卡片樣式 */
    .stat-card, .group-stat-card {
      background-color: #FFFFFF; border: 1px solid #E5E7EB;
      border-radius: 0.75rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }
    .group-stat-card { padding: 1rem 1.25rem; }

    /* 按鈕樣式 */
    .action-button {
      background-color: #2563EB; border: 1px solid #2563EB; color: #FFFFFF; 
      font-weight: bold; padding: 0.5rem 1.2rem; border-radius: 0.5rem; 
      transition: all 0.3s; font-size: 0.875rem; cursor: pointer;
    }
    .action-button:hover { background-color: #1D4ED8; }

    /* 分頁按鈕 */
    .tab-btn {
      padding: 0.6rem 1.5rem; border-radius: 0.5rem; font-weight: bold;
      cursor: pointer; border: 1px solid; font-size: 1.1rem; margin-right: 0.5rem;
      transition: all 0.2s;
    }
    .tab-active {
      background-color: #2563EB; color: #FFFFFF; border-color: #2563EB;
    }
    .tab-inactive {
      background-color: #FFFFFF; color: #2563EB; border-color: #93C5FD;
    }
    .tab-inactive:hover { background-color: #EFF6FF; }

    /* 表格樣式 - 固定欄寬與捲動 */
    .table-container {
      background-color: #FFFFFF; border-radius: 0.75rem; border: 1px solid #E5E7EB;
      overflow: hidden; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }
    /* 關鍵：允許水平捲動 */
    .table-scroll-wrapper { 
      overflow-x: auto; -webkit-overflow-scrolling: touch; 
    }
    
    /* 表格設定 */
    table { 
      width: 100%; 
      border-collapse: collapse; 
      /* 設定最小寬度，確保在手機上撐開寬度，觸發左右滑動 */
      min-width: 700px; 
      table-layout: fixed; 
    }
    
    th {
      background-color: #F9FAFB; color: #4B5563; font-size: 0.9rem;
      padding: 1rem; text-align: left; white-space: nowrap;
      border-bottom: 1px solid #E5E7EB;
    }
    td {
      padding: 1rem; border-bottom: 1px solid #E5E7EB;
      font-size: 1rem; color: #374151; 
      white-space: nowrap; /* 不換行，強制寬度生效 */
      overflow: hidden; text-overflow: ellipsis; /* 過長省略 */
    }

    /* 狀態樣式 */
    .row-checked-in { background-color: #EFF6FF; } /* 已報到淺藍底 */
    .row-checked-in:hover { background-color: #DBEAFE; }
    .row-pending:hover { background-color: #F9FAFB; }
    
    /* 強制狀態欄位顏色 */
    .text-success { color: #1D4ED8 !important; font-weight: bold; } /* 藍色字 */
    .text-error-light { color: #D97706; font-weight: bold; }

    .hidden { display: none; }
    .error-box {
      background-color: #FEF2F2; border: 1px solid #FCA5A5; 
      color: #991B1B; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem;
    }
    
    .spinner-small {
      display: inline-block; width: 1rem; height: 1rem; border: 2px solid rgba(255, 255, 255, 0.6);
      border-left-color: #FFFFFF; border-radius: 50%; animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
  </style>
</head>
<body class="bg-gray-100"> 
  <div class="overlay-content">
    
    <!-- 標題 -->
    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
      <div class="text-center md:text-left">
        <h1 class="text-3xl font-bold text-gray-800 leading-tight">
          醫學教育共識營 
          <!-- 強制換行 span -->
          <span class="block mt-1 sm:inline sm:mt-0 text-blue-700">即時報到儀表板</span> 
        </h1>
      </div>
      <button id="refreshButton" onclick="fetchData()" class="action-button flex items-center justify-center">
        <span id="refreshSpinner" class="hidden spinner-small mr-2"></span>
        <span id="refreshText">立即更新</span>
      </button>
    </div>

    <!-- 分頁與統計 -->
    <div class="flex flex-col md:flex-row justify-between items-end border-b-2 border-gray-200 pb-4 mb-6 gap-4">
      <div class="flex flex-col sm:flex-row items-center gap-4 w-full md:w-auto">
        <div class="flex">
          <button id="tabButtonOverview" onclick="showTab('Overview')" class="tab-btn tab-active">總覽儀表板</button>
          <button id="tabButtonGroupRosters" onclick="showTab('GroupRosters')" class="tab-btn tab-inactive">各組詳細名單</button>
        </div>
        <p id="totalCountMetadata" class="hidden text-lg text-gray-600">
          總報名人數：<span id="statTotal" class="font-bold text-gray-900">0</span> 人
        </p>
      </div>
      <div id="lastUpdatedMetadata" class="hidden text-sm text-gray-500">
        最後更新：<span id="lastUpdated" class="font-semibold text-gray-700">N/A</span> (每 30 秒更新)
      </div>
    </div>

    <!-- 載入與錯誤訊息 -->
    <div id="fullLoading" class="text-center py-20 text-xl text-gray-500">載入報到資料中，請稍候...</div>
    <div id="errorMessage" class="hidden error-box">
      <strong class="font-bold">發生錯誤：</strong><span class="block sm:inline" id="errorText"></span>
      <p id="errorHint" class="hidden mt-2 text-sm">提示：請確認您已將 `Code.gs` 重新部署為新版本。</p>
    </div>

    <!-- 分頁一：總覽 -->
    <div id="tabOverview" class="hidden">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="stat-card p-6 text-center">
          <h2 class="text-lg font-semibold text-gray-600">報到率</h2>
          <p class="text-5xl font-extrabold text-blue-600 mt-2"><span id="statRate">0</span><span class="text-3xl">%</span></p>
        </div>
        <div class="stat-card p-6 text-center">
          <h2 class="text-lg font-semibold text-gray-600">已報到總人數</h2>
          <p class="text-5xl font-extrabold text-blue-600 mt-2" id="statCheckedIn">0</p>
        </div>
        <div class="stat-card p-6 text-center">
          <h2 class="text-lg font-semibold text-gray-600">未報到人數</h2>
          <p class="text-5xl font-extrabold text-orange-500 mt-2" id="statPending">0</p>
        </div>
      </div>

      <div id="groupStatsSection" class="mb-10">
        <div class="flex items-baseline space-x-3 mb-4 border-b-2 border-gray-200 pb-2">
          <h2 class="text-2xl font-bold text-gray-800">各組報到狀況</h2>
          <span class="text-sm text-gray-500">(15:50–16:30各功能小組分組討論)</span>
        </div>
        <div id="groupStatsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5"></div>
      </div>
      
      <div class="grid grid-cols-1 gap-10"> 
        <!-- 已報到名單 (移除地點欄位) -->
        <div>
          <h2 class="text-2xl font-bold text-gray-800 border-b-2 border-gray-200 pb-2 mb-4">已報到名單 (<span id="checkedInListCount">0</span>)</h2>
          <div class="table-container"><div class="table-scroll-wrapper">
            <table class="min-w-full divide-y divide-gray-200 table-fixed">
              <thead>
                <tr>
                  <th class="px-6 py-4 text-left font-medium uppercase tracking-wider" style="width: 25%">姓名</th> 
                  <th class="px-6 py-4 text-left font-medium uppercase tracking-wider" style="width: 35%">單位</th> 
                  <th class="px-6 py-4 text-left font-medium uppercase tracking-wider" style="width: 20%">職稱</th> 
                  <th class="px-6 py-4 text-left font-medium uppercase tracking-wider" style="width: 20%">分組組別</th> 
                </tr>
              </thead>
              <tbody id="checkedInTableBody" class="divide-y divide-gray-200"></tbody>
            </table>
          </div></div>
        </div>

        <!-- 未報到名單 (移除地點欄位) -->
        <div>
          <h2 class="text-2xl font-bold text-gray-800 border-b-2 border-gray-200 pb-2 mb-4">未報到名單 (<span id="pendingListCount">0</span>)</h2>
          <div class="table-container"><div class="table-scroll-wrapper">
            <table class="min-w-full divide-y divide-gray-200 table-fixed">
              <thead>
                <tr>
                  <th class="px-6 py-4 text-left font-medium uppercase tracking-wider" style="width: 25%">姓名</th>
                  <th class="px-6 py-4 text-left font-medium uppercase tracking-wider" style="width: 35%">單位</th>
                  <th class="px-6 py-4 text-left font-medium uppercase tracking-wider" style="width: 20%">職稱</th>
                  <th class="px-6 py-4 text-left font-medium uppercase tracking-wider" style="width: 20%">分組組別</th>
                </tr>
              </thead>
              <tbody id="pendingTableBody" class="divide-y divide-gray-200"></tbody>
            </table>
          </div></div>
        </div>
      </div>
    </div>

    <!-- 分頁二：各組詳細 -->
    <div id="tabGroupRosters" class="hidden">
      <p class="text-base text-gray-600 mb-6">此處顯示所有組別的完整名單及個人的即時報到狀態。 (可左右滑動表格查看完整資訊)</p>
      <div id="rosterErrorHint" class="hidden text-center p-8 bg-amber-50 rounded-lg border border-amber-200">
        <p class="text-xl font-semibold text-amber-700">未偵測到「各組詳細名單」資料</p>
        <p class="text-lg text-amber-600 mt-2">請確認您已經將最新的 `Code.gs` 檔案**重新部署**。</p>
      </div>
      <div id="groupRosterContainer" class="space-y-10"></div>
    </div>
  </div>

  <script>
    // !!! 務必確認此網址是您最新部署的網址 !!!
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbweDq70D9T01XvspyieBBLVFmXOY3WsP0ZaWR0k68XM5IRtgmKmtODfoT43h0JCMrIbwg/exec";
    const GROUP_ORDER = ["指導長官", "教育輔導組", "數位賦能組", "醫學人文組", "核心能力組", "教學品質組", "其他"];

    const fullLoading = document.getElementById('fullLoading');
    const errorMessage = document.getElementById('errorMessage');
    const errorText = document.getElementById('errorText');
    const errorHint = document.getElementById('errorHint'); 
    const refreshButton = document.getElementById('refreshButton');
    const refreshText = document.getElementById('refreshText');
    const refreshSpinner = document.getElementById('refreshSpinner');
    const totalCountMetadata = document.getElementById('totalCountMetadata'); 
    const lastUpdatedMetadata = document.getElementById('lastUpdatedMetadata'); 
    const statTotal = document.getElementById('statTotal');
    const lastUpdated = document.getElementById('lastUpdated');
    const groupStatsContainer = document.getElementById('groupStatsContainer');
    const tabOverview = document.getElementById('tabOverview');
    const tabGroupRosters = document.getElementById('tabGroupRosters');
    const tabButtonOverview = document.getElementById('tabButtonOverview');
    const tabButtonGroupRosters = document.getElementById('tabButtonGroupRosters');
    const rosterErrorHint = document.getElementById('rosterErrorHint');
    const groupRosterContainer = document.getElementById('groupRosterContainer');

    function showTab(tabName) {
      if (tabName === 'Overview') {
        tabOverview.classList.remove('hidden'); tabGroupRosters.classList.add('hidden');
        tabButtonOverview.className = 'tab-btn tab-active'; tabButtonGroupRosters.className = 'tab-btn tab-inactive';
      } else {
        tabOverview.classList.add('hidden'); tabGroupRosters.classList.remove('hidden');
        tabButtonOverview.className = 'tab-btn tab-inactive'; tabButtonGroupRosters.className = 'tab-btn tab-active';
      }
    }

    async function fetchData() {
      console.log("Fetching data...");
      refreshText.textContent = "更新中...";
      refreshSpinner.classList.remove('hidden');
      refreshButton.disabled = true;
      try {
        const response = await fetch(WEB_APP_URL, {
          method: 'POST', mode: 'cors',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify({ action: "getDashboardData" })
        });
        if (!response.ok) throw new Error(`HTTP 錯誤! 狀態: ${response.status}`);
        const data = await response.json();
        updateDashboard(data);
      } catch (error) {
        console.error("Fetch error:", error);
        showError(error);
      }
    }

    function updateDashboard(data) {
      fullLoading.classList.add('hidden');
      if (data.success) {
        totalCountMetadata.classList.remove('hidden');
        lastUpdatedMetadata.classList.remove('hidden');
        errorMessage.classList.add('hidden');
        
        if (tabButtonOverview.classList.contains('tab-active')) {
            tabOverview.classList.remove('hidden');
        }

        statTotal.textContent = data.stats.total;
        lastUpdated.textContent = new Date().toLocaleTimeString('zh-TW');

        document.getElementById('statRate').textContent = data.stats.rate;
        document.getElementById('statCheckedIn').textContent = data.stats.checkedIn;
        document.getElementById('statPending').textContent = data.stats.pending;

        groupStatsContainer.innerHTML = '';
        if (data.groupStats) {
          const sorted = data.groupStats.sort((a, b) => {
            const iA = GROUP_ORDER.indexOf(a.name), iB = GROUP_ORDER.indexOf(b.name);
            return (iA === -1 ? 99 : iA) - (iB === -1 ? 99 : iB);
          });
          sorted.forEach(g => {
            groupStatsContainer.innerHTML += `
              <div class="group-stat-card">
                <div class="flex justify-between items-center">
                  <h3 class="text-lg font-semibold text-gray-700 truncate" title="${g.name}">${g.name}</h3>
                  <span class="text-base font-bold text-gray-800">${g.checkedIn} <span class="text-sm font-normal text-gray-500">/ ${g.total}</span></span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5 mt-3">
                  <div class="bg-gradient-to-r from-blue-400 to-blue-500 h-2.5 rounded-full" style="width: ${g.rate}%"></div>
                </div>
              </div>`;
          });
        }

        const fillTable = (id, list, emptyMsg, colCount) => {
          const tbody = document.getElementById(id);
          tbody.innerHTML = '';
          if (list.length === 0) tbody.innerHTML = `<tr><td colspan="${colCount}" class="px-6 py-4 text-center text-gray-500 text-base">${emptyMsg}</td></tr>`;
          else list.forEach(p => {
            let rowClass = id === 'checkedInTableBody' ? 'row-checked-in' : 'row-pending';
            tbody.innerHTML += `
              <tr class="${rowClass} hover:bg-gray-50">
                <td class="px-6 py-4 font-medium text-gray-900">${p.name}</td>
                <td class="px-6 py-4 text-gray-600">${p.unit}</td>
                <td class="px-6 py-4 text-gray-600">${p.title}</td>
                <td class="px-6 py-4 text-gray-600">${p.group}</td>
              </tr>`;
          });
        };
        document.getElementById('checkedInListCount').textContent = data.lists.checkedIn.length;
        fillTable('checkedInTableBody', data.lists.checkedIn, '目前無人報到', 4);
        
        document.getElementById('pendingListCount').textContent = data.lists.pending.length;
        fillTable('pendingTableBody', data.lists.pending, '全員到齊！', 4);

        groupRosterContainer.innerHTML = '';
        if (!data.groupedRosters) rosterErrorHint.classList.remove('hidden');
        else {
          rosterErrorHint.classList.add('hidden');
          GROUP_ORDER.forEach(gName => {
            const members = data.groupedRosters[gName];
            const location = data.groupLocations ? data.groupLocations[gName] : ""; 
            
            if (members && members.length > 0) {
              const checkedCount = members.filter(m => m.status === '已報到').length;
              let rows = '';
              members.forEach(m => {
                const isChk = m.status === '已報到';
                rows += `
                  <tr class="${isChk ? 'row-checked-in' : 'row-pending'}">
                    <td class="w-1/4 px-6 py-4 font-medium text-gray-900">${m.name}</td>
                    <td class="w-1/4 px-6 py-4 text-gray-600">${m.unit}</td>
                    <td class="w-1/4 px-6 py-4 text-gray-600">${m.title}</td>
                    <td class="w-1/4 px-6 py-4 ${isChk ? 'text-success' : 'text-error-light'}">${m.status}</td>
                  </tr>`;
              });
              
              const locationHtml = location ? `<span class="block sm:inline text-lg text-gray-500 font-normal ml-0 sm:ml-2">(${location})</span>` : "";
              
              groupRosterContainer.innerHTML += `
                <div>
                  <h3 class="text-2xl font-bold text-gray-800 border-b-2 border-gray-200 pb-2 mb-4">
                    ${gName} 
                    ${locationHtml}
                    <span class="text-lg font-normal text-gray-500 ml-2">(已報到: ${checkedCount} / ${members.length})</span>
                  </h3>
                  <!-- Table Scroll Wrapper with fixed width to force scroll on mobile -->
                  <div class="table-container"><div class="table-scroll-wrapper"><table class="table-fixed min-w-full divide-y divide-gray-200" style="min-width: 700px;">
                    <thead><tr>
                      <th class="w-1/4 px-6 py-4 text-left font-medium uppercase tracking-wider">姓名</th>
                      <th class="w-1/4 px-6 py-4 text-left font-medium uppercase tracking-wider">單位</th>
                      <th class="w-1/4 px-6 py-4 text-left font-medium uppercase tracking-wider">職稱</th>
                      <th class="w-1/4 px-6 py-4 text-left font-medium uppercase tracking-wider">報到狀態</th>
                    </tr></thead>
                    <tbody class="divide-y divide-gray-200">${rows}</tbody>
                  </table></div></div>
                </div>`;
            }
          });
        }
      } else {
        showError({ message: data.message || "資料格式錯誤" });
      }
      refreshText.textContent = "立即更新";
      refreshSpinner.classList.add('hidden');
      refreshButton.disabled = false;
    }

    function showError(error) {
      console.error("Fetch error:", error);
      fullLoading.classList.add('hidden');
      totalCountMetadata.classList.add('hidden');
      lastUpdatedMetadata.classList.add('hidden');
      errorText.textContent = error.message;
      errorMessage.classList.remove('hidden');
      if (error.message && error.message.includes("undefined")) errorHint.classList.remove('hidden');
      else errorHint.classList.add('hidden');
      refreshText.textContent = "立即更新";
      refreshSpinner.classList.add('hidden');
      refreshButton.disabled = false;
    }

    document.addEventListener('DOMContentLoaded', fetchData);
    setInterval(fetchData, 30000); 
  </script>
</body>
</html>
