<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>功能小組年度策略報告</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 載入 Noto Sans TC 字體 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <!-- 
      客製化 Tailwind 顏色
      採用高對比、適合投影的深海軍藍
    -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['"Noto Sans TC"', 'sans-serif'],
                    },
                    colors: {
                        'cmh-blue': '#003D74',
                        'cmh-accent': '#00B9E9',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: #F3F4F6; /* bg-gray-100 */
        }
        
        main {
            flex-grow: 1;
        }

        /* 載入中 Spinner */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            display: inline-block;
            width: 5rem; /* 80px */
            height: 5rem; /* 80px */
            border-radius: 50%;
            border: 8px solid rgba(0, 61, 116, 0.2); /* cmh-blue with opacity */
            border-top-color: #003D74; /* cmh-blue */
            animation: spin 1s linear infinite;
        }

        /* 幻燈片淡入動畫 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .slide-content {
            animation: fadeIn 0.5s ease-out;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen text-gray-900 flex flex-col">

    <!-- Header 區塊 (高對比) -->
    <!-- 【★★ 功能新增：顏色將由 JS 動態切換 ★★】 -->
    <header class="relative bg-cmh-blue pb-24 pt-12 text-white transition-colors duration-500">
        <!-- 【★★ 視覺修正：(gen_38) 調整標題層級 ★★】 -->
        <div class="container mx-auto max-w-6xl px-4 text-center">
            <p class="text-2xl md:text-3xl opacity-90 font-medium">「創造360°人生」醫學教育共識營</p>
            <h1 class="text-4xl md:text-5xl font-black mt-2 tracking-wide">功能小組年度策略報告</h1>
        </div>
        <!-- 斜角設計 -->
        <!-- 【★★ 視覺修正：加高高度至 h-24 以消除細線 ★★】 -->
        <div class="absolute bottom-0 left-0 w-full h-24 bg-gray-100" style="clip-path: polygon(0 100%, 100% 0, 100% 100%);"></div>
    </header>

    <!-- 報告主容器 -->
    <main class="container mx-auto max-w-6xl px-4 pb-24 flex-grow">
        
        <!-- 載入中訊息 -->
        <div id="loading" class="relative -mt-16 bg-white rounded-xl shadow-2xl p-10 md:p-16 text-center">
            <div class="spinner"></div>
            <p class="text-2xl font-semibold text-cmh-blue mt-4">正在從 Google Sheet 載入資料...</p>
        </div>

        <!-- 簡報幻燈片容器 (預設隱藏) -->
        <div id="reportContainer" class="hidden">
            <!-- 幻燈片主體 -->
            <div id="slideContainer" class="relative -mt-16 bg-white rounded-xl shadow-2xl p-10 md:p-16">
                <!-- 內容將由 JS 動態填入 -->
            </div>
            
            <!-- 【★★ 視覺修正：導覽列移至右下方 ★★】 -->
            <nav class="mt-8 flex justify-end">
                <div class="w-full md:w-96">
                    <label for="groupSelect" class="sr-only">請選擇要報告的組別</label>
                    <!-- 【★★ 功能新增：顏色將由 JS 動態切換 ★★】 -->
                    <select id="groupSelect"
                        class="w-full text-center text-lg md:text-xl px-4 py-3 bg-white rounded-lg border-2 border-cmh-blue focus:outline-none focus:ring-2 focus:ring-cmh-blue focus:border-transparent transition-colors duration-500 shadow-md font-semibold">
                        <!-- 組別選項將由 JS 動態填入 -->
                    </select>
                </div>
            </nav>
        </div>

    </main>

    <!-- 【★★ 功能新增：顏色將由 JS 動態切換 ★★】 -->
    <footer class="w-full bg-cmh-blue text-white mt-auto relative pt-20 transition-colors duration-500"> <!-- 增加 pt -->
        <!-- 【★★ 視覺修正：(gen_56) 直接裁切 Footer，消除白線 ★★】 -->
        <!-- 使用 calc() 確保高度足夠覆蓋細線，且角度正確 -->
        <div class="absolute top-0 left-0 w-full h-24 bg-gray-100" style="clip-path: polygon(0 100%, 100% 0, 0 0);"></div>
        
        <!-- Footer 內容 -->
        <div class="relative container mx-auto max-w-6xl px-4 py-6 text-center text-gray-300">
            © 2025 Chi Mei Medical Center. All rights reserved.
        </div>
    </footer>


    <!-- JavaScript 腳本 -->
    <script>
        // -------------------------------------------------------------------------
        // ！！！Google Apps Script 網路應用程式 URL！！！
        // -------------------------------------------------------------------------
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby6HlqKxbzbAdlyNksypmA6krSOSxHZTnTIamFWnSxgc3C6m7Zxb6ANMAkZ0M8ddgw/exec';
        // -------------------------------------------------------------------------

        const loadingEl = document.getElementById('loading');
        const reportContainerEl = document.getElementById('reportContainer');
        const slideContainerEl = document.getElementById('slideContainer');
        const groupSelectEl = document.getElementById('groupSelect');

        // 【★★ 功能新增：(gen_53) 取得 Header 和 Footer ★★】
        const headerEl = document.querySelector('header');
        const footerEl = document.querySelector('footer');

        let allData = []; // 用來儲存所有抓到的資料
        let currentIndex = 0; // 目前顯示的資料索引

        // 【★★ 色彩修正：(gen_55) 第二套配色方案 ★★】
        const groupThemes = {
            '教育輔導組': { 
                bg: 'bg-cmh-blue',      // 奇美藍 (標準)
                text: 'text-cmh-blue', 
                accent: 'text-cmh-accent', 
                border: 'border-cmh-blue', 
                ring: 'focus:ring-cmh-blue' 
            },
            '數位賦能組': { 
                bg: 'bg-teal-700',      // 深青色 (靈感：杯子亮藍)
                text: 'text-teal-700', 
                accent: 'text-teal-400', 
                border: 'border-teal-700', 
                ring: 'focus:ring-teal-700' 
            },
            '醫學人文組': { 
                bg: 'bg-amber-800',    // 暖琥珀色 (靈感：桌面)
                text: 'text-amber-800', 
                accent: 'text-amber-500', 
                border: 'border-amber-800', 
                ring: 'focus:ring-amber-800' 
            },
            '核心能力組': { 
                bg: 'bg-indigo-800',    // 深靛藍 (專業)
                text: 'text-indigo-800', 
                accent: 'text-indigo-400', 
                border: 'border-indigo-800', 
                ring: 'focus:ring-indigo-800' 
            },
            '教學品質組': { 
                bg: 'bg-green-800',     // 森林綠 (沉穩)
                text: 'text-green-800', 
                accent: 'text-green-400', 
                border: 'border-green-800', 
                ring: 'focus:ring-green-800' 
            }
        };
        // 用來清除舊顏色的列表
        const allThemeClasses = {
            bg: ['bg-cmh-blue', 'bg-teal-700', 'bg-amber-800', 'bg-indigo-800', 'bg-green-800'],
            border: ['border-cmh-blue', 'border-teal-700', 'border-amber-800', 'border-indigo-800', 'border-green-800'],
            ring: ['focus:ring-cmh-blue', 'focus:ring-teal-700', 'focus:ring-amber-800', 'focus:ring-indigo-800', 'focus:ring-green-800']
        };

        /**
         * 【★★ 功能新增：(gen_53) 動態套用主題色 ★★】
         * @param {object} theme - 來自 groupThemes 的主題物件
         */
        const applyTheme = (theme) => {
            // 1. 清除所有可能的舊顏色
            headerEl.classList.remove(...allThemeClasses.bg);
            footerEl.classList.remove(...allThemeClasses.bg);
            groupSelectEl.classList.remove(...allThemeClasses.border, ...allThemeClasses.ring);

            // 2. 套用新顏色
            headerEl.classList.add(theme.bg);
            footerEl.classList.add(theme.bg);
            groupSelectEl.classList.add(theme.border, theme.ring);
        };


        /**
         * 輔助函數：處理空值和保留換行 (移除清單符號)
         * @param {string|number} text - 原始資料
         * @returns {string} - 格式化後的 HTML
         */
        const formatReportText = (text) => {
            // 【★★ 關鍵修正：先強制轉為字串 ★★】
            // 避免傳入數字 (如 123) 時造成 .trim() 錯誤
            const str = (text === null || text === undefined) ? '' : String(text);

            if (str.trim() === '') {
                return '<span class="text-gray-400">無</span>';
            }
            // 1. 編碼 (防止 XSS)
            const encodedText = str.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            // 2. 轉換換行符
            return encodedText.replace(/\n/g, '<br>');
        };

        /**
         * 輔助函數：產生單一計畫項目的 HTML
         * @param {string} label - 標籤 (例如 "行動名稱 1:")
         * @param {string|number} content - 填寫的內容
         * @returns {string} - 格式化後的 HTML
         */
        const createPlanItemHTML = (label, content) => {
            // 【★★ 關鍵修正：先強制轉為字串 ★★】
            const str = (content === null || content === undefined) ? '' : String(content);
            
            if (str.trim() === '') {
                return ''; // 如果內容為空，不顯示
            }
            const encodedContent = str.replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\n/g, '<br>');
            return `
                <div class="flex flex-col md:flex-row md:items-start mt-4">
                    <strong class="text-xl md:text-2xl font-semibold text-gray-800 flex-shrink-0 w-full md:w-56">${label}:</strong>
                    <div class="text-xl md:text-2xl text-gray-700 flex-grow mt-1 md:mt-0">${encodedContent}</div>
                </div>`;
        };

        /**
         * 產生幻燈片 HTML 內容
         * @param {object} data - 單一小組的資料
         * @param {object} theme - 【★★ 功能新增：(gen_53) 傳入主題物件 ★★】
         * @returns {string} - 完整的 HTML
         */
        const createSlideHTML = (data, theme) => {
            let plansHtml = '';
            for (let i = 1; i <= 5; i++) {
                const name = data[`actionName${i}`];
                const content = data[`actionContent${i}`];
                const kpi = data[`kpi${i}`];

                // 檢查是否有內容 (轉字串後判斷)
                if (String(name || '').trim() || String(content || '').trim() || String(kpi || '').trim()) {
                    // 【★★ 視覺修正：(gen_39) 劃分區塊 ★★】
                    plansHtml += `
                        <div class="mt-6 p-6 bg-gray-50 rounded-lg shadow-inner space-y-4">
                            ${createPlanItemHTML(`行動名稱 ${i}`, name)}
                            ${createPlanItemHTML(`行動內容 ${i}`, content)}
                            ${createPlanItemHTML(`KPI ${i}`, kpi)}
                        </div>`;
                }
            }
            if (plansHtml === '') {
                // 【★★ 文字修正：(gen_46) "未填寫" 改為 "無" ★★】
                plansHtml = `<div class="mt-4 text-xl md:text-2xl text-gray-500">無</div>`;
            }

            // 【★★ 功能新增：(gen_53) 動態替換顏色 ★★】
            // 【★★ 視覺修正：(gen_36) 顏色對調 ★★】
            return `
                <div class="slide-content space-y-10">
                    <!-- 基本資料 -->
                    <section>
                        <h2 class="text-4xl md:text-5xl font-black ${theme.accent}">${data.groupName || '未提供組別'}</h2>
                        <p class="text-2xl md:text-3xl font-semibold ${theme.text} mt-2">${data.reporterName || '未提供報告人'}</p>
                    </section>
                    
                    <!-- 一、願景 -->
                    <section>
                        <h3 class="text-3xl md:text-4xl font-bold ${theme.text}">一、功能小組的願景</h3>
                        <!-- 【★★ 視覺修正：(gen_38) 統一內容字體 ★★】 -->
                        <div class="mt-4 text-xl md:text-2xl text-gray-700 space-y-2 leading-relaxed">
                            ${formatReportText(data.vision)}
                        </div>
                    </section>
                    
                    <!-- 二、年度目標 -->
                    <section>
                        <h3 class="text-3xl md:text-4xl font-bold ${theme.text}">二、年度目標</h3>
                        <div class="mt-4 text-xl md:text-2xl text-gray-700 space-y-2 leading-relaxed">
                            ${formatReportText(data.goals)}
                        </div>
                    </section>
                    
                    <!-- 三、年度計畫 -->
                    <section>
                        <h3 class="text-3xl md:text-4xl font-bold ${theme.text}">三、年度計畫</h3>
                        ${plansHtml}
                    </section>

                    <!-- 四、支持與合作 -->
                    <section>
                        <h3 class="text-3xl md:text-4xl font-bold ${theme.text}">四、需要的支持與合作</h3>
                        <div class="mt-4 text-xl md:text-2xl text-gray-700 space-y-2 leading-relaxed">
                             ${formatReportText(data.support)}
                        </div>
                    </section>
                    
                    <!-- 五、其他補充 -->
                    <section>
                        <h3 class="text-3xl md:text-4xl font-bold ${theme.text}">五、其他補充</h3>
                        <div class="mt-4 text-xl md:text-2xl text-gray-700 space-y-2 leading-relaxed">
                             ${formatReportText(data.other)}
                        </div>
                    </section>
                </div>
            `;
        };

        /**
         * 更新顯示的幻燈片
         * @param {number} index - 資料的索引
         */
        const updateSlide = (index) => {
            if (index < 0 || index >= allData.length) return;
            
            currentIndex = index;
            const data = allData[index];
            
            // 【★★ 功能新增：(gen_53) 根據組別名稱決定主題 ★★】
            const groupName = data.groupName || '教育輔導組'; // 預設為奇美藍
            // 【★★ 色彩修正：(gen_54) / (gen_55) ★★】
            const theme = groupThemes[groupName] || groupThemes['教育輔導組'];
            
            // 【★★ 功能新增：(gen_53) 套用主題色 ★★】
            applyTheme(theme);
            
            // 【★★ 功能新增：(gen_53) 將主題色傳入 ★★】
            slideContainerEl.innerHTML = createSlideHTML(data, theme);
            
            // 更新下拉選單的選中狀態
            groupSelectEl.value = index;
        };

        /**
         * 處理 JSONP 抓到的資料
         * @param {object | object[]} data - 從 Apps Script 回傳的資料
         */
        window.handleData = (data) => {
            if (data && data.result === 'error') {
                // 處理 Code.gs 內部的錯誤
                console.error('Apps Script 錯誤:', data.message);
                loadingEl.innerHTML = `
                    <p class="text-3xl font-bold text-red-600">抓取資料失敗！</p>
                    <p class="text-xl text-gray-700 mt-4">請檢查 Apps Script 部署狀態或 Google Sheet 權限。</p>
                    <p class="text-lg text-gray-500 mt-2">錯誤訊息: ${data.message}</p>
                `;
                return;
            }

            if (data && data.length > 0) {
                // 【★★ 重要修正：過濾資料時更寬容 ★★】
                // 有時候第一欄是空的但後面有資料，我們只要確保有 groupName 就好
                allData = data.filter(row => row.groupName);
                
                if (allData.length > 0) {
                    // 填入下拉選單
                    groupSelectEl.innerHTML = allData.map((item, index) => {
                        return `<option value="${index}">${item.groupName} - ${item.reporterName || '未填寫'}</option>`;
                    }).join('');
                    
                    // 綁定下拉選單事件
                    groupSelectEl.addEventListener('change', (e) => {
                        updateSlide(parseInt(e.target.value, 10));
                    });
                    
                    // 顯示第一筆資料
                    updateSlide(0);
                    
                    // 顯示報告容器，隱藏載入中
                    loadingEl.classList.add('hidden');
                    reportContainerEl.classList.remove('hidden');

                } else {
                     // 【★★ 文字修正：(gen_46) "未填寫" 改為 "無" ★★】
                     loadingEl.innerHTML = '<p class="text-3xl font-bold text-cmh-blue">目前 Google Sheet 中沒有可顯示的資料。</p>';
                }

            } else {
                // 沒有資料
                // 【★★ 文字修正：(gen_46) "未填寫" 改為 "無" ★★】
                loadingEl.innerHTML = '<p class="text-3xl font-bold text-cmh-blue">目前 Google Sheet 中沒有可顯示的資料。</p>';
            }
        };

        /**
         * (主函數) 透過 JSONP 方式抓取資料
         */
        const fetchData = () => {
            const script = document.createElement('script');
            // 加上 callback=handleData 和一個隨機數 (防止快取)
            script.src = `${GOOGLE_APPS_SCRIPT_URL}?callback=handleData&_=${new Date().getTime()}`;
            
            script.onerror = () => {
                // 處理網路層級的錯誤 (例如 CORS 錯誤或網址錯誤)
                console.error('抓取資料失敗: 網路或 JSONP 錯誤。');
                loadingEl.innerHTML = `
                    <p class="text-3xl font-bold text-red-600">抓取資料失敗！ (Fetch Error)</p>
                    <p class="text-xl text-gray-700 mt-4">請檢查 Google Apps Script 網址是否正確，以及部署的「誰可以存取」是否設為「任何人」。</p>
                `;
            };
            document.body.appendChild(script);
        };

        // 頁面載入時自動執行
        document.addEventListener('DOMContentLoaded', fetchData);
        
    </script>

</body>
</html>
